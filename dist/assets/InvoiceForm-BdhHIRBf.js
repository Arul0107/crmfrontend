import{r as h,P as p,n as e,T as Y,B as S,D as le}from"./index-oy8H7GhK.js";import{R as be}from"./jspdf.es.min-DoQ0mABm.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{d as $,D as z}from"./index-DpE6QBp4.js";import{i as L,R as j,C as i}from"./axios-BiOpeFGb.js";import{F as l}from"./index-DAy7P-Ze.js";import{t as Ie}from"./index-CDljd3rJ.js";import{C as A}from"./index-CqmmXAmh.js";import{S as v}from"./index-D9k2VRo4.js";import{I as m}from"./index-Bkpz4I_k.js";import{R as B}from"./index-DHoVrESs.js";import{D as C}from"./index-BzVPwHj-.js";import{T as _}from"./index-5ThmN9aO.js";import{R as Te}from"./DeleteOutlined-CgFrUMoj.js";import{R as ve}from"./MinusCircleOutlined-BoJiSwQf.js";import{R as Fe}from"./index-BGnynlHZ.js";import{R as Ce}from"./SaveOutlined-BakIzLAx.js";const{Option:f}=v,{TextArea:de}=m,{useToken:we}=Ie,Ue=({onCancel:ie,onSave:ce,initialValues:d,isSaving:N})=>{var oe;const[I]=l.useForm(),[y,b]=h.useState([{id:1,productId:null,description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[E,U]=h.useState("pending"),[ue,me]=h.useState([]),[w,H]=h.useState(null),[P,he]=h.useState([]),[O,X]=h.useState(),[W,xe]=h.useState([]),[x,M]=h.useState(null),[g,J]=h.useState(null),{token:o}=we(),n={mainCardTitle:{fontSize:"20px",fontWeight:"bold",color:o.colorPrimary},quotationCard:{borderRadius:o.borderRadiusLG,boxShadow:o.boxShadowSecondary},formField:{width:"100%"},readOnlyFormField:{width:"100%",backgroundColor:o.colorFillAlter,color:o.colorTextDisabled,cursor:"not-allowed"},textAreaField:{width:"100%",resize:"vertical"},readOnlyTextArea:{backgroundColor:o.colorFillAlter,color:o.colorTextDisabled},businessInfoCard:{backgroundColor:o.colorFillAlter,borderColor:o.colorBorderSecondary,borderRadius:o.borderRadiusSM},businessInfoPre:{whiteSpace:"pre-wrap",fontFamily:"Roboto, sans-serif",fontSize:o.fontSizeSM,color:o.colorTextSecondary,margin:0},divider:{margin:"24px 0",borderColor:o.colorBorderSecondary,borderStyle:"dashed"},itemCard:{marginBottom:o.margin,borderRadius:o.borderRadius,border:`1px solid ${o.colorBorder}`},deleteButton:{color:o.colorError},specificationDivider:{margin:"16px 0 8px 0",fontSize:o.fontSizeSM,color:o.colorTextSecondary},specificationRow:{marginBottom:o.marginXS},addButton:{width:"100%",borderColor:o.colorPrimaryBorder,color:o.colorPrimary},addSpecButton:{marginTop:o.margin,borderColor:o.colorBorder,color:o.colorTextSecondary},addItemButton:{marginTop:o.margin,borderColor:o.colorBorder,color:o.colorTextSecondary},summaryRow:{marginBottom:o.margin},totalField:{backgroundColor:o.colorFillAlter,color:o.colorText,fontWeight:"bold",fontSize:o.fontSizeLG},grandTotalField:{backgroundColor:o.colorSuccessBg,color:o.colorSuccessText,fontWeight:"bold",fontSize:o.fontSizeXL},notesCard:{backgroundColor:o.colorFillAlter,borderColor:o.colorBorderSecondary,borderRadius:o.borderRadiusSM},noteText:{marginBottom:o.marginXS,color:o.colorTextSecondary},buttonGroup:{marginTop:o.marginXL,textAlign:"right"}},G=h.useRef(!1),q=h.useRef(!1),pe=()=>{try{const t=JSON.parse(localStorage.getItem("user"));return(t==null?void 0:t.email)||"Unknown"}catch{return"Unknown"}},D=h.useCallback(t=>{var r,s;return t?`
${(r=t.businessName)==null?void 0:r.toUpperCase()}
${t.contactName?`Mr. ${(s=t.contactName)==null?void 0:s.toUpperCase()}`:""}
${t.addressLine1||""}${t.addressLine2?", "+t.addressLine2:""}
${t.city||""}${t.pincode?" - "+t.pincode:""}
${t.state||""}, ${t.country||""}
${t.gstNumber||""}
`.trim():""},[]),K=h.useCallback(async()=>{if(G.current)return;G.current=!0;const t=p.loading("Loading business options...");try{const r=await L.get("/api/invoices/leads/active");he(r.data),p.success("Business options loaded",{id:t})}catch(r){p.error("Failed to load businesses",{id:t}),console.error("Error fetching business options:",r),G.current=!1}},[]),Q=h.useCallback(async()=>{const t=p.loading("Loading invoice types...");try{const r=await L.get("/api/invoices/types");me(r.data),p.success("Invoice types loaded",{id:t})}catch(r){p.error("Failed to load invoice types",{id:t}),console.error("Error fetching invoice types:",r)}},[]),Z=h.useCallback(async()=>{if(q.current)return;q.current=!0;const t=p.loading("Loading product options...");try{const r=await L.get("/api/product");xe(r.data.map(s=>({...s,hsnSac:s.hsnSac||"",quantityType:s.quantityType||"",options:s.options||[]}))),p.success("Product options loaded",{id:t})}catch(r){p.error("Failed to load products",{id:t}),console.error("Error fetching product options:",r),q.current=!1}},[]);h.useEffect(()=>{var t;if(K(),Z(),Q(),d){const r=((t=d.businessId)==null?void 0:t._id)||d.businessId,s=P.find(a=>a._id===r);I.setFieldsValue({...d,date:d.date?$(d.date):null,dueDate:d.dueDate?$(d.dueDate):null,paymentStatus:d.paymentStatus||"pending",invoiceType:d.invoiceType||"Invoice",gstType:d.gstType||null,businessName:s==null?void 0:s.businessName,businessType:s==null?void 0:s.type,businessInfo:s?D(s):"",gstin:(s==null?void 0:s.gstNumber)||"",businessId:s==null?void 0:s._id}),b(d.items||[]),U(d.paymentStatus||"pending"),H(d.dueDate?$(d.dueDate):null),J(d.gstType||null),X(d.gstPercentage||0),s&&M(s)}},[d,P,K,Z,I,D,Q]);const ye=()=>{const t=Math.max(0,...y.map(r=>r.id))+1;b([...y,{id:t,productId:null,description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}])},F=(t,r,s)=>{b(y.map(a=>{if(a.id===t){if(r==="productId"){const c=W.find(u=>u._id===s);if(c)return{...a,productId:s,description:c.description||"",hsnSac:c.hsnSac||"",rate:c.price||0,quantityType:c.quantityType||"",specifications:c.options&&c.options.length>0?c.options.map(u=>({key:Date.now()+Math.random(),name:u.type||"",value:u.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...a,[r]:s}}return a}))},je=t=>{b(y.filter(r=>r.id!==t))},V=t=>{b(r=>r.map(s=>s.id===t?{...s,specifications:[...s.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:s))},fe=(t,r)=>{b(s=>s.map(a=>a.id===t?{...a,specifications:a.specifications.filter(c=>c.key!==r)}:a))},ee=(t,r,s,a)=>{b(c=>c.map(u=>u.id===t?{...u,specifications:u.specifications.map(T=>T.key===r?{...T,[s]:a}:T)}:u))},R=()=>y.reduce((t,r)=>t+(r.quantity||0)*(r.rate||0),0),k=()=>R()*(O/100),te=()=>g==="interstate"?k():0,re=()=>g==="intrastate"?k()/2:0,ne=()=>g==="intrastate"?k()/2:0,se=()=>R()+k(),ge=t=>{const r=P.find(s=>s._id===t);if(r){M(r);const s=D(r);I.setFieldsValue({businessId:r._id,businessName:r.businessName,businessType:r.type,gstin:r.gstNumber,businessInfo:s})}else M(null),I.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:""})},Se=t=>{var T,ae;if(!y||y.length===0){p.error("At least one item is required.");return}if(!g){p.error("Please select a GST type.");return}const r=R(),s=O,a=se(),c={amount:t.newPaymentAmount,method:t.newPaymentMethod,reference:t.newPaymentReference,date:(T=t.newPaymentDate)==null?void 0:T.format("YYYY-MM-DD"),addedBy:pe()},u={...t,date:(ae=t.date)==null?void 0:ae.format("YYYY-MM-DD"),dueDate:w==null?void 0:w.format("YYYY-MM-DD"),paymentStatus:E,items:y,subTotal:r,gstPercentage:s,totalAmount:a,gstType:g,igstAmount:te(),cgstAmount:re(),sgstAmount:ne(),businessName:x==null?void 0:x.businessName,businessType:x==null?void 0:x.type,gstin:x==null?void 0:x.gstNumber,businessInfo:x?D(x):""};c.amount&&c.method&&(u.paymentHistory=[...(d==null?void 0:d.paymentHistory)||[],c]),delete u.newPaymentAmount,delete u.newPaymentMethod,delete u.newPaymentReference,delete u.newPaymentDate,ce(u)};return e.jsx(A,{title:e.jsx("span",{style:n.mainCardTitle,children:d?"Edit Invoice":"Create New Invoice"}),loading:N,style:n.quotationCard,children:e.jsxs(l,{form:I,layout:"vertical",onFinish:Se,children:[e.jsxs(j,{gutter:[16,24],children:[e.jsxs(i,{xs:24,md:12,children:[e.jsx(l.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(v,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(t,r)=>((r==null?void 0:r.children)||"").toLowerCase().includes(t.toLowerCase()),onChange:ge,allowClear:!0,style:n.formField,children:P.map(t=>e.jsx(f,{value:t._id,children:t.businessName},t._id))})}),e.jsx(l.Item,{name:"businessName",hidden:!0,children:e.jsx(m,{})})]}),e.jsx(i,{xs:24,md:12,children:e.jsx(l.Item,{name:"businessType",label:"Type",children:e.jsx(m,{readOnly:!0,style:n.readOnlyFormField})})})]}),e.jsxs(j,{gutter:[24],children:[e.jsx(i,{xs:24,md:12,children:e.jsx(l.Item,{label:"Business Info",children:e.jsx(A,{bordered:!0,style:n.businessInfoCard,children:e.jsx("pre",{style:n.businessInfoPre,children:I.getFieldValue("businessInfo")||"Select a business to view details..."})})})}),e.jsx(i,{xs:24,md:12,children:e.jsx(l.Item,{label:"Invoice Type",name:"invoiceType",rules:[{required:!0,message:"Please select an invoice type"}],children:e.jsx(v,{placeholder:"Select invoice type",style:n.formField,allowClear:!0,children:ue.map(t=>e.jsx(f,{value:t,children:t},t))})})})]}),e.jsxs(j,{gutter:16,children:[(d==null?void 0:d.invoiceNumber)&&e.jsx(i,{span:12,children:e.jsx(l.Item,{label:"Invoice Number",children:e.jsx(m,{value:d.invoiceNumber,readOnly:!0,style:n.readOnlyFormField})})}),e.jsx(i,{span:12,children:e.jsx(l.Item,{label:"GSTIN",name:"gstin",children:e.jsx(m,{readOnly:!0,style:n.readOnlyFormField})})})]}),e.jsxs(j,{gutter:16,children:[e.jsx(i,{span:12,children:e.jsx(l.Item,{label:"Date",name:"date",rules:[{required:!0}],children:e.jsx(z,{style:n.formField,format:"DD/MM/YYYY"})})}),e.jsx(i,{span:12,children:e.jsx(l.Item,{label:"Due Date",name:"dueDate",children:e.jsx(z,{style:n.formField,format:"DD/MM/YYYY",value:w,onChange:H})})})]}),e.jsx(l.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0}],children:e.jsx(m,{style:n.formField})}),e.jsx(l.Item,{label:"Customer Address",name:"customerAddress",rules:[{required:!0}],children:e.jsx(de,{rows:2,style:n.textAreaField})}),e.jsx(l.Item,{label:"Payment Status",name:"paymentStatus",children:e.jsxs(B.Group,{value:E,onChange:t=>U(t.target.value),children:[e.jsx(B.Button,{value:"pending",children:"Pending"}),e.jsx(B.Button,{value:"partial",children:"Partial"}),e.jsx(B.Button,{value:"paid",children:"Paid"})]})}),e.jsx(C,{style:n.divider,children:"Invoice Items"}),y.map((t,r)=>{const s=t.productId!==null;return e.jsxs(A,{style:n.itemCard,size:"small",children:[e.jsxs(j,{gutter:[16,16],align:"middle",children:[e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Product",noStyle:!0,children:e.jsx(v,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(a,c)=>((c==null?void 0:c.children)||"").toLowerCase().includes(a.toLowerCase()),onChange:a=>F(t.id,"productId",a),value:t.productId,style:n.formField,children:W.map(a=>e.jsx(f,{value:a._id,children:a.productName||a.name},a._id))})})}),e.jsx(i,{xs:12,sm:4,children:e.jsx(l.Item,{label:"Qty",noStyle:!0,children:e.jsx(_,{placeholder:"1",value:t.quantity,onChange:a=>F(t.id,"quantity",a),style:n.formField,min:0})})}),e.jsx(i,{xs:12,sm:6,children:e.jsx(l.Item,{label:"Unit Type",noStyle:!0,children:e.jsx(m,{placeholder:"e.g., Pcs, Kg, Mtr",value:t.quantityType,onChange:a=>F(t.id,"quantityType",a.target.value),style:s?n.readOnlyFormField:n.formField})})}),e.jsx(i,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:y.length>1&&e.jsx(Y,{title:"Remove Item",children:e.jsx(S,{icon:e.jsx(Te,{}),danger:!0,onClick:()=>je(t.id),type:"text",style:n.deleteButton})})})]}),e.jsxs(j,{gutter:[16,16],style:{marginTop:o.marginS},children:[e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(m,{prefix:"₹",value:t.rate.toFixed(2),readOnly:!0,style:n.readOnlyFormField})})}),e.jsx(i,{xs:24,sm:16,children:e.jsx(l.Item,{label:"Description",noStyle:!0,children:e.jsx(de,{placeholder:"Detailed description of the item",value:t.description,onChange:a=>F(t.id,"description",a.target.value),style:n.textAreaField,rows:2})})})]}),e.jsxs(j,{gutter:[16,16],style:{marginTop:o.marginS},children:[e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(m,{placeholder:"HSN/SAC",value:t.hsnSac,onChange:a=>F(t.id,"hsnSac",a.target.value),style:s?n.readOnlyFormField:n.formField})})}),e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Item Total",noStyle:!0,children:e.jsx(m,{value:`₹${((t.quantity||0)*(t.rate||0)).toFixed(2)}`,readOnly:!0,style:n.totalField})})})]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(C,{orientation:"left",style:n.specificationDivider,children:"Specifications"}),t.specifications.map((a,c)=>e.jsxs(j,{gutter:16,style:n.specificationRow,align:"middle",children:[e.jsx(i,{xs:24,sm:10,children:e.jsx(m,{placeholder:"Specification Name (e.g., Color)",value:a.name,onChange:u=>ee(t.id,a.key,"name",u.target.value),style:n.formField})}),e.jsx(i,{xs:24,sm:10,children:e.jsx(m,{placeholder:"Specification Value (e.g., Blue)",value:a.value,onChange:u=>ee(t.id,a.key,"value",u.target.value),style:n.formField})}),e.jsx(i,{xs:24,sm:4,children:e.jsxs(le,{children:[t.specifications.length>1&&e.jsx(Y,{title:"Remove Specification",children:e.jsx(S,{icon:e.jsx(ve,{}),onClick:()=>fe(t.id,a.key),type:"text",danger:!0,style:n.deleteButton})}),c===t.specifications.length-1&&e.jsx(Y,{title:"Add New Specification",children:e.jsx(S,{icon:e.jsx(Fe,{}),onClick:()=>V(t.id),type:"dashed",style:n.addButton})})]})})]},a.key))]}),(!t.specifications||t.specifications.length===0||t.specifications.length>0&&t.specifications[t.specifications.length-1].name&&t.specifications[t.specifications.length-1].value)&&e.jsx(S,{onClick:()=>V(t.id),block:!0,type:"dashed",style:n.addSpecButton,children:"+ Add Specification"})]},t.id)}),e.jsx(S,{onClick:ye,block:!0,type:"dashed",style:n.addItemButton,children:"+ Add Another Item"}),e.jsx(C,{style:n.divider,children:"Summary"}),e.jsx(i,{xs:24,md:12,children:e.jsx(l.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(v,{placeholder:"Select GST calculation type",onChange:t=>J(t),value:g,style:n.formField,children:[e.jsx(f,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(f,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsxs(j,{gutter:[16,16],style:n.summaryRow,children:[e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Sub Total",children:e.jsx(m,{readOnly:!0,value:`₹${R().toFixed(2)}`,style:n.totalField})})}),e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"GST Rate (%)",children:e.jsx(_,{min:0,max:100,step:.1,value:O,onChange:X,style:n.formField})})}),g==="interstate"&&e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"IGST Amount",children:e.jsx(m,{readOnly:!0,value:`₹${te().toFixed(2)}`,style:n.totalField})})}),g==="intrastate"&&e.jsxs(e.Fragment,{children:[e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"CGST Amount",children:e.jsx(m,{readOnly:!0,value:`₹${re().toFixed(2)}`,style:n.totalField})})}),e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"SGST Amount",children:e.jsx(m,{readOnly:!0,value:`₹${ne().toFixed(2)}`,style:n.totalField})})})]}),e.jsx(i,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Grand Total",children:e.jsx(m,{readOnly:!0,value:`₹${se().toFixed(2)}`,style:n.grandTotalField})})})]}),e.jsx(C,{children:"Payment History"}),((oe=d==null?void 0:d.paymentHistory)==null?void 0:oe.length)>0&&e.jsx("div",{style:{marginBottom:16},children:d.paymentHistory.map((t,r)=>e.jsxs(A,{size:"small",style:{marginBottom:8},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Amount:"})," ₹",t.amount]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," ",t.method]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",t.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reference:"})," ",t.reference]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Added By:"})," ",t.addedBy]})]},r))}),e.jsx(C,{children:"Add Payment Entry"}),e.jsxs(j,{gutter:16,children:[e.jsx(i,{span:6,children:e.jsx(l.Item,{label:"Amount",name:"newPaymentAmount",children:e.jsx(_,{min:0,style:n.formField})})}),e.jsx(i,{span:6,children:e.jsx(l.Item,{label:"Method",name:"newPaymentMethod",children:e.jsxs(v,{placeholder:"Select method",style:n.formField,children:[e.jsx(f,{value:"Cash",children:"Cash"}),e.jsx(f,{value:"Bank",children:"Bank"}),e.jsx(f,{value:"UPI",children:"UPI"}),e.jsx(f,{value:"Cheque",children:"Cheque"})]})})}),e.jsx(i,{span:6,children:e.jsx(l.Item,{label:"Reference",name:"newPaymentReference",children:e.jsx(m,{style:n.formField})})}),e.jsx(i,{span:6,children:e.jsx(l.Item,{label:"Date",name:"newPaymentDate",children:e.jsx(z,{style:n.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(l.Item,{style:n.buttonGroup,children:e.jsxs(le,{size:"middle",children:[e.jsx(S,{onClick:ie,size:"large",disabled:N,children:"Cancel"}),e.jsx(S,{type:"primary",htmlType:"submit",icon:e.jsx(Ce,{}),size:"large",loading:N,children:d?"Update Invoice":"Save Invoice"}),e.jsx(S,{icon:e.jsx(be,{}),size:"large",onClick:()=>window.print(),children:"Print"})]})})]})})};export{Ue as default};
