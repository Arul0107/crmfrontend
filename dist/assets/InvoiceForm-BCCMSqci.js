import{r as x,P as b,n as e,T as W,B as I,D as ae}from"./index-DACmc7pB.js";import{d as J,D as Q}from"./index-Cyup4WG3.js";import{i as de,R as f,C as l}from"./axios-Du1nVyMf.js";import{F as c}from"./index-cCYLImr3.js";import{t as ge}from"./index-DoQgX8uM.js";import{C as O}from"./index-BBnB1Ydf.js";import{S as k}from"./index-BZvStfzR.js";import{I as h}from"./index-BPBZGrcT.js";import{D as R}from"./index-Cew9PPFX.js";import{T as G}from"./index-C8AIGYAp.js";import{R as be}from"./DeleteOutlined-BRmaC2Ts.js";import{R as Ie}from"./MinusCircleOutlined-DiYk7URA.js";import{R as Se}from"./index-BFaAVFfK.js";import{R as q}from"./index-CS05F-Wf.js";import{R as Te}from"./SaveOutlined-BcgD8fDg.js";import{R as ve}from"./PrinterOutlined-D7X2hOKb.js";const{Option:g}=k,{TextArea:Ce}=h,{useToken:Ne}=ge,_e=({onCancel:ce,onSave:le,initialValues:o,isSaving:B})=>{var se;const[S]=c.useForm(),[y,T]=x.useState([{id:1,productId:null,productName:"",description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[$,K]=x.useState("pending"),[v,Z]=x.useState(null),[N,ie]=x.useState([]),[A,V]=x.useState(18),[C,me]=x.useState([]),[u,z]=x.useState(null),[j,ee]=x.useState(null),{token:a}=Ne(),s={mainCardTitle:{fontSize:"20px",fontWeight:"bold",color:a.colorPrimary},quotationCard:{borderRadius:a.borderRadiusLG},formField:{width:"100%"},readOnlyFormField:{width:"100%",backgroundColor:a.colorFillAlter,color:a.colorTextDisabled,cursor:"not-allowed"},readOnlyTextArea:{backgroundColor:a.colorFillAlter,color:a.colorTextDisabled},businessInfoCard:{backgroundColor:a.colorFillAlter,borderColor:a.colorBorderSecondary,borderRadius:a.borderRadiusSM},businessInfoPre:{whiteSpace:"pre-wrap",fontFamily:"Roboto, sans-serif",fontSize:a.fontSizeSM,color:a.colorTextSecondary,margin:0},divider:{margin:"24px 0",borderColor:a.colorBorderSecondary},itemCard:{marginBottom:a.margin,borderRadius:a.borderRadius,border:`1px solid ${a.colorBorder}`},deleteButton:{color:a.colorError},specificationDivider:{margin:"16px 0 8px 0",fontSize:a.fontSizeSM,color:a.colorTextSecondary},specificationRow:{marginBottom:a.marginXS},addButton:{width:"100%",borderColor:a.colorPrimaryBorder,color:a.colorPrimary},addSpecButton:{marginTop:a.margin,borderColor:a.colorBorder,color:a.colorTextSecondary},addItemButton:{marginTop:a.margin,borderColor:a.colorBorder,color:a.colorTextSecondary},summaryRow:{marginBottom:a.margin},totalField:{backgroundColor:a.colorFillAlter,color:a.colorText,fontWeight:"bold",fontSize:a.fontSizeLG},grandTotalField:{backgroundColor:a.colorSuccessBg,color:a.colorSuccessText,fontWeight:"bold",fontSize:a.fontSizeXL},notesCard:{backgroundColor:a.colorFillAlter,borderColor:a.colorBorderSecondary,borderRadius:a.borderRadiusSM},noteText:{marginBottom:a.marginXS,color:a.colorTextSecondary},buttonGroup:{marginTop:a.marginXL,textAlign:"right"}},L=x.useRef(!1),_=x.useRef(!1),ue=()=>{try{const t=JSON.parse(localStorage.getItem("user"));return(t==null?void 0:t.email)||"Unknown"}catch{return"Unknown"}},F=x.useCallback(t=>{var n,r;return t?`
${(n=t.businessName)==null?void 0:n.toUpperCase()}
${t.contactName?`Mr. ${(r=t.contactName)==null?void 0:r.toUpperCase()}`:""}
${t.addressLine1||""}${t.addressLine2?", "+t.addressLine2:""}
${t.city||""}${t.pincode?" - "+t.pincode:""}
${t.state||""}, ${t.country||""}
${t.gstNumber||""}
`.trim():""},[]),te=x.useCallback(async()=>{if(L.current)return;L.current=!0;const t=b.loading("Loading business options...");try{const n=await de.get("/api/invoices/leads/active");ie(n.data),b.success("Business options loaded",{id:t})}catch(n){b.error("Failed to load businesses",{id:t}),console.error("Error fetching business options:",n),L.current=!1}},[]),re=x.useCallback(async()=>{if(_.current)return;_.current=!0;const t=b.loading("Loading product options...");try{const n=await de.get("/api/product");me(n.data.map(r=>({...r,hsnSac:r.hsnSac||"",quantityType:r.quantityType||"",options:r.options||[]}))),b.success("Product options loaded",{id:t})}catch(n){b.error("Failed to load products",{id:t}),console.error("Error fetching product options:",n),_.current=!1}},[]);x.useEffect(()=>{te(),re()},[te,re]),x.useEffect(()=>{var t;if(o&&C.length>0&&N.length>0){console.log("Initial Values Effect triggered."),console.log("initialValues:",o),console.log("productOptions:",C);const n=((t=o.businessId)==null?void 0:t._id)||o.businessId,r=N.find(d=>d._id===n);S.setFieldsValue({...o,date:o.date?J(o.date):null,dueDate:o.dueDate?J(o.dueDate):null,paymentStatus:o.paymentStatus||"pending",invoiceType:"Invoice",gstType:o.gstType||null,businessName:r==null?void 0:r.businessName,businessType:r==null?void 0:r.type,businessInfo:r?F(r):"",gstin:(r==null?void 0:r.gstNumber)||"",businessId:r==null?void 0:r._id,contactName:o.contactName||"",email:o.email||"",mobileNumber:o.mobileNumber||""});const i=o.items.map(d=>{var D;const m=((D=d.productId)==null?void 0:D._id)||d.productId,p=C.find(Y=>Y._id===m);return console.log("--- Item Processing ---"),console.log("Original item.productId:",d.productId),console.log("ID used for lookup (currentProductId):",m),console.log("Found product:",p),{...d,id:d.id||Date.now()+Math.random(),productId:m,productName:d.productName||(p?p.productName||p.name:d.description||"Product Not Found"),rate:d.rate||(p?p.price:0),description:d.description||(p?p.description:""),hsnSac:d.hsnSac||(p?p.hsnSac:""),quantityType:d.quantityType||(p?p.quantityType:""),specifications:d.specifications||(p&&p.options?p.options.map(Y=>({key:Date.now()+Math.random(),name:Y.type||"",value:Y.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}])}});T(i),console.log("Updated Items after mapping:",i),K(o.paymentStatus||"pending"),Z(o.dueDate?J(o.dueDate):null),ee(o.gstType||null),V(o.gstPercentage||18),r&&z(r)}},[o,C,N,S,F]);const pe=()=>{const t=Math.max(0,...y.map(n=>n.id))+1;T([...y,{id:t,productId:null,productName:"",description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now()+Math.random(),name:"",value:""}]}])},P=(t,n,r)=>{T(y.map(i=>{if(i.id===t){if(n==="productId"){const d=C.find(m=>m._id===r);if(d)return{...i,productId:r,productName:d.productName||d.name,description:d.description||"",hsnSac:d.hsnSac||"",rate:d.price||0,quantityType:d.quantityType||"",specifications:d.options&&d.options.length>0?d.options.map(m=>({key:Date.now()+Math.random(),name:m.type||"",value:m.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...i,[n]:r}}return i}))},he=t=>{T(y.filter(n=>n.id!==t))},ne=t=>{T(n=>n.map(r=>r.id===t?{...r,specifications:[...r.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:r))},xe=(t,n)=>{T(r=>r.map(i=>i.id===t?{...i,specifications:i.specifications.filter(d=>d.key!==n)}:i))},oe=(t,n,r,i)=>{T(d=>d.map(m=>m.id===t?{...m,specifications:m.specifications.map(p=>p.key===n?{...p,[r]:i}:p)}:m))},w=()=>y.reduce((t,n)=>t+(n.quantity||0)*(n.rate||0),0),M=()=>w()*(A/100),E=()=>j==="interstate"?M():0,U=()=>j==="intrastate"?M()/2:0,H=()=>j==="intrastate"?M()/2:0,X=()=>w()+M(),ye=t=>{const n=N.find(r=>r._id===t);if(n){z(n);const r=F(n);S.setFieldsValue({businessId:n._id,businessName:n.businessName,businessType:n.type,gstin:n.gstNumber,businessInfo:r,contactName:n.contactName||"",email:n.email||"",mobileNumber:n.mobileNumber||""})}else z(null),S.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:"",contactName:"",email:"",mobileNumber:""})},fe=t=>{var p,D;if(!y||y.length===0){b.error("At least one item is required.");return}if(!j){b.error("Please select a GST type.");return}const n=w(),r=A,i=X(),d={amount:t.newPaymentAmount,method:t.newPaymentMethod,reference:t.newPaymentReference,date:(p=t.newPaymentDate)==null?void 0:p.format("YYYY-MM-DD"),addedBy:ue()},m={...t,date:(D=t.date)==null?void 0:D.format("YYYY-MM-DD"),dueDate:v==null?void 0:v.format("YYYY-MM-DD"),paymentStatus:$,items:y,subTotal:n,gstPercentage:r,totalAmount:i,gstType:j,igstAmount:E(),cgstAmount:U(),sgstAmount:H(),invoiceType:"Invoice",businessName:u==null?void 0:u.businessName,businessType:u==null?void 0:u.type,gstin:u==null?void 0:u.gstNumber,businessInfo:u?F(u):"",contactName:t.contactName,email:t.email,mobileNumber:t.mobileNumber};d.amount&&d.method&&(m.paymentHistory=[...(o==null?void 0:o.paymentHistory)||[],d]),delete m.newPaymentAmount,delete m.newPaymentMethod,delete m.newPaymentReference,delete m.newPaymentDate,le(m)},je=()=>{var m;const t=S.getFieldsValue(!0),n=w(),r=A,i=X(),d={...t,date:(m=t.date)==null?void 0:m.format("YYYY-MM-DD"),dueDate:v==null?void 0:v.format("YYYY-MM-DD"),paymentStatus:$,items:y,subTotal:n,gstPercentage:r,totalAmount:i,gstType:j,igstAmount:E(),cgstAmount:U(),sgstAmount:H(),invoiceNumber:(o==null?void 0:o.invoiceNumber)||"DRAFT",invoiceType:"Invoice",businessName:u==null?void 0:u.businessName,businessType:u==null?void 0:u.type,gstin:u==null?void 0:u.gstNumber,businessInfo:u?F(u):"",contactName:t.contactName,email:t.email,mobileNumber:t.mobileNumber,companyName:"Your Company Name",companyAddress:"Your Company Address Line 1, City, State - PIN, Country",companyGSTIN:"YOURGSTIN12345",notes:(o==null?void 0:o.notes)||[],paymentTerms:(o==null?void 0:o.paymentTerms)||"Payment due within 15 days of invoice date"};localStorage.setItem("invoiceToPrint",JSON.stringify(d)),window.open("/print-invoice","_blank")};return e.jsx(O,{title:e.jsx("span",{style:s.mainCardTitle,children:o?"Edit Invoice":"Create New Invoice"}),loading:B,style:s.quotationCard,children:e.jsxs(c,{form:S,layout:"vertical",onFinish:fe,children:[e.jsxs(f,{gutter:[16,24],children:[e.jsxs(l,{xs:24,md:12,children:[e.jsx(c.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(k,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(t,n)=>((n==null?void 0:n.children)||"").toLowerCase().includes(t.toLowerCase()),onChange:ye,allowClear:!0,style:s.formField,children:N.map(t=>e.jsx(g,{value:t._id,children:t.businessName},t._id))})}),e.jsx(c.Item,{name:"businessName",hidden:!0,children:e.jsx(h,{})})]}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{name:"businessType",label:"Type",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(f,{gutter:[24],children:[e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{label:"Business Info",children:e.jsx(O,{bordered:!0,style:s.businessInfoCard,children:e.jsx("pre",{style:s.businessInfoPre,children:S.getFieldValue("businessInfo")||"Select a business to view details..."})})})}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{label:"Invoice Type",name:"invoiceType",initialValue:"Invoice",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(f,{gutter:16,children:[(o==null?void 0:o.invoiceNumber)&&e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Invoice Number",children:e.jsx(h,{value:o.invoiceNumber,readOnly:!0,style:s.readOnlyFormField})})}),e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"GSTIN",name:"gstin",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(f,{gutter:16,children:[e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Date",name:"date",rules:[{required:!0}],children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY"})})}),e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Due Date",name:"dueDate",children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY",value:v,onChange:Z})})})]}),e.jsxs(f,{gutter:16,children:[e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Contact Person",name:"contactName",rules:[{required:!0,message:"Please enter contact person name!"}],children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Email",name:"email",rules:[{required:!0,type:"email",message:"Please enter a valid email!"}],children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Mobile Number",name:"mobileNumber",rules:[{required:!0,message:"Please enter mobile number!"}],children:e.jsx(h,{style:s.formField})})})]}),e.jsx(R,{style:s.divider,children:"Invoice Items"}),y.map((t,n)=>e.jsxs(O,{style:s.itemCard,size:"small",children:[e.jsxs(f,{gutter:[16,16],align:"middle",children:[e.jsxs(l,{xs:24,sm:8,children:["Product Name",e.jsx(c.Item,{label:"Product",noStyle:!0,children:e.jsxs(k,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(r,i)=>((i==null?void 0:i.children)||"").toLowerCase().includes(r.toLowerCase()),onChange:r=>P(t.id,"productId",r),value:t.productId,style:s.formField,children:[t.productName&&!C.some(r=>r._id===t.productId)&&e.jsx(g,{value:t.productId,children:t.productName},t.productId),C.map(r=>e.jsxs(g,{value:r._id,children:[r.productName||r.name," "]},r._id))]},t.productId||`new-item-${t.id}`)})]}),e.jsxs(l,{xs:12,sm:8,children:["Quantity",e.jsx(c.Item,{label:"Qty",noStyle:!0,children:e.jsx(G,{placeholder:"1",value:t.quantity,onChange:r=>P(t.id,"quantity",r),style:s.formField,min:0})})]}),e.jsxs(l,{xs:24,sm:8,children:["Price (per unit)",e.jsx(c.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(G,{prefix:"₹",value:t.rate,onChange:r=>P(t.id,"rate",r),min:0,step:.01,style:s.formField})})]}),e.jsx(l,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:y.length>1&&e.jsx(W,{title:"Remove Item",children:e.jsx(I,{icon:e.jsx(be,{}),danger:!0,onClick:()=>he(t.id),type:"text",style:s.deleteButton})})})]}),e.jsxs(f,{gutter:[16,16],style:{marginTop:a.margin},children:[e.jsxs(l,{xs:24,sm:8,children:["HSN/SAC Code",e.jsx(c.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(h,{placeholder:"HSN/SAC",value:t.hsnSac,onChange:r=>P(t.id,"hsnSac",r.target.value)})})]}),e.jsxs(l,{xs:24,sm:8,children:["Item Total",e.jsx(c.Item,{label:"Item Total",noStyle:!0,children:e.jsx(h,{value:`₹${((t.quantity||0)*(t.rate||0)).toFixed(2)}`,readOnly:!0,style:s.totalField})})]}),e.jsxs(l,{xs:24,sm:8,children:["Description",e.jsx(c.Item,{label:"Description",noStyle:!0,children:e.jsx(Ce,{placeholder:"Detailed description of the item",value:t.description,onChange:r=>P(t.id,"description",r.target.value),rows:2})})]})]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(R,{orientation:"left",style:s.specificationDivider,children:"Specifications"}),t.specifications.map((r,i)=>e.jsxs(f,{gutter:16,style:s.specificationRow,align:"middle",children:[e.jsx(l,{xs:24,sm:10,children:e.jsx(h,{placeholder:"Specification Name (e.g., Color)",value:r.name,onChange:d=>oe(t.id,r.key,"name",d.target.value),style:s.formField})}),e.jsx(l,{xs:24,sm:10,children:e.jsx(h,{placeholder:"Specification Value (e.g., Blue)",value:r.value,onChange:d=>oe(t.id,r.key,"value",d.target.value),style:s.formField})}),e.jsx(l,{xs:24,sm:4,children:e.jsxs(ae,{children:[t.specifications.length>1&&e.jsx(W,{title:"Remove Specification",children:e.jsx(I,{icon:e.jsx(Ie,{}),onClick:()=>xe(t.id,r.key),type:"text",danger:!0,style:s.deleteButton})}),i===t.specifications.length-1&&e.jsx(W,{title:"Add New Specification",children:e.jsx(I,{icon:e.jsx(Se,{}),onClick:()=>ne(t.id),type:"dashed",style:s.addButton})})]})})]},r.key))]}),(!t.specifications||t.specifications.length===0||t.specifications.length>0&&t.specifications[t.specifications.length-1].name&&t.specifications[t.specifications.length-1].value)&&e.jsx(I,{onClick:()=>ne(t.id),block:!0,type:"dashed",style:s.addSpecButton,children:"+ Add Specification"})]},t.id)),e.jsx(I,{onClick:pe,block:!0,type:"dashed",style:s.addItemButton,children:"+ Add Another Item"}),e.jsx(R,{style:s.divider,children:"Summary"}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(k,{placeholder:"Select GST calculation type",onChange:t=>ee(t),value:j,style:s.formField,children:[e.jsx(g,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(g,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsxs(f,{gutter:[16,16],style:s.summaryRow,children:[e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"Sub Total",children:e.jsx(h,{readOnly:!0,value:`₹${w().toFixed(2)}`,style:s.totalField})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"GST Rate (%)",children:e.jsx(G,{min:0,max:100,step:.1,value:A,onChange:V,style:s.formField})})}),j==="interstate"&&e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"IGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${E().toFixed(2)}`,style:s.totalField})})}),j==="intrastate"&&e.jsxs(e.Fragment,{children:[e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"CGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${U().toFixed(2)}`,style:s.totalField})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"SGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${H().toFixed(2)}`,style:s.totalField})})})]}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"Grand Total",children:e.jsx(h,{readOnly:!0,value:`₹${X().toFixed(2)}`,style:s.grandTotalField})})})]}),e.jsx(c.Item,{label:"Payment Status",name:"paymentStatus",children:e.jsxs(q.Group,{value:$,onChange:t=>K(t.target.value),children:[e.jsx(q.Button,{value:"pending",children:"Pending"}),e.jsx(q.Button,{value:"partial",children:"Partial"}),e.jsx(q.Button,{value:"paid",children:"Paid"})]})}),e.jsx(R,{children:"Payment History"}),((se=o==null?void 0:o.paymentHistory)==null?void 0:se.length)>0&&e.jsx("div",{style:{marginBottom:16},children:o.paymentHistory.map((t,n)=>e.jsxs(O,{size:"small",style:{marginBottom:8},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Amount:"})," ₹",t.amount]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," ",t.method]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",t.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reference:"})," ",t.reference]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Added By:"})," ",t.addedBy]})]},n))}),e.jsx(R,{children:"Add Payment Entry"}),e.jsxs(f,{gutter:16,children:[e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Amount",name:"newPaymentAmount",children:e.jsx(G,{min:0,style:s.formField})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Method",name:"newPaymentMethod",children:e.jsxs(k,{placeholder:"Select method",style:s.formField,children:[e.jsx(g,{value:"Cash",children:"Cash"}),e.jsx(g,{value:"Bank",children:"Bank"}),e.jsx(g,{value:"UPI",children:"UPI"}),e.jsx(g,{value:"Cheque",children:"Cheque"})]})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Reference",name:"newPaymentReference",children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Date",name:"newPaymentDate",children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(c.Item,{style:s.buttonGroup,children:e.jsxs(ae,{size:"middle",children:[e.jsx(I,{onClick:ce,size:"large",disabled:B,children:"Cancel"}),e.jsx(I,{type:"primary",htmlType:"submit",icon:e.jsx(Te,{}),size:"large",loading:B,children:o?"Update Invoice":"Save Invoice"}),e.jsx(I,{icon:e.jsx(ve,{}),size:"large",onClick:je,children:"Print"})]})})]})})};export{_e as default};
