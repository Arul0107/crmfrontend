import{r as y,V as j,n as r,T as Y,B as F,D as Z}from"./index-oy8H7GhK.js";import{i as k,R as I,C as d}from"./axios-BiOpeFGb.js";import{d as ee,D as re}from"./index-DpE6QBp4.js";import{F as n}from"./index-DAy7P-Ze.js";import{t as me}from"./index-CDljd3rJ.js";import{C as $}from"./index-CqmmXAmh.js";import{D as v}from"./index-BzVPwHj-.js";import{I as x}from"./index-Bkpz4I_k.js";import{S as M}from"./index-D9k2VRo4.js";import{T as pe}from"./index-5ThmN9aO.js";import{R as he}from"./DeleteOutlined-CgFrUMoj.js";import{R as xe}from"./MinusCircleOutlined-BoJiSwQf.js";import{R as ye}from"./index-BGnynlHZ.js";import{R as ge}from"./SaveOutlined-BakIzLAx.js";const fe=e=>({quotationCard:{borderRadius:e.borderRadiusXL,boxShadow:e.boxShadowSecondary,border:`1px solid ${e.colorBorderBg}`,backgroundColor:e.colorBgContainer,padding:e.paddingLG},mainCardTitle:{color:e.colorPrimary,fontSize:e.fontSizeHeading2,fontWeight:e.fontWeightStronger,marginBottom:e.marginLG,textAlign:"center",textTransform:"uppercase",letterSpacing:"1px"},businessInfoCard:{background:`linear-gradient(135deg, ${e.colorFillQuaternary} 0%, ${e.colorFillAlter} 100%)`,border:`1px solid ${e.colorBorderSecondary}`,borderRadius:e.borderRadiusLG,padding:e.paddingMD,minHeight:"80px",boxShadow:e.boxShadowTertiary,marginBottom:e.marginLG,display:"flex",alignItems:"center",transition:"all 0.3s ease-in-out","&:hover":{boxShadow:e.boxShadow,transform:"translateY(-2px)"}},businessInfoPre:{margin:0,whiteSpace:"pre-wrap",flexGrow:1,fontFamily:"monospace",fontSize:e.fontSizeSM,color:e.colorTextSecondary,lineHeight:e.lineHeightSM,opacity:.8},formField:{width:"100%",borderRadius:e.borderRadiusSM,borderColor:e.colorBorder,transition:"all 0.2s ease","&:hover":{borderColor:e.colorPrimaryBorder},"&:focus":{boxShadow:`0 0 0 2px ${e.colorPrimaryBorderHover}`}},readOnlyFormField:{width:"100%",color:e.colorTextDisabled,borderRadius:e.borderRadiusSM,background:e.colorFillQuaternary,cursor:"not-allowed"},textAreaField:{width:"100%",marginBottom:e.marginS,borderRadius:e.borderRadiusSM,borderColor:e.colorBorder},readOnlyTextArea:{width:"100%",marginBottom:e.marginS,borderRadius:e.borderRadiusSM,color:e.colorTextDisabled,background:e.colorFillQuaternary,cursor:"not-allowed"},divider:{borderColor:e.colorBorderSecondary,borderStyle:"dashed",margin:`${e.marginXL}px 0`,color:e.colorTextTertiary,fontWeight:e.fontWeightStrong},specificationDivider:{borderColor:e.colorBorderSecondary,borderStyle:"dotted",margin:`${e.margin}px 0 ${e.marginS}px 0`,color:e.colorTextQuaternary},itemCard:{marginBottom:e.marginMD,border:`1px solid ${e.colorBorderSecondary}`,borderRadius:e.borderRadiusLG,backgroundColor:e.colorFillContentBackground,transition:"all 0.2s ease-in-out","&:hover":{boxShadow:e.boxShadowXl,transform:"translateY(-3px)"}},deleteButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:e.colorError,"&:hover":{color:e.colorErrorHover,background:e.colorErrorBg}},addButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:e.colorPrimary,borderColor:e.colorPrimaryBorder,"&:hover":{color:e.colorPrimaryHover,borderColor:e.colorPrimaryBorderHover,background:e.colorPrimaryBg}},addSpecButton:{marginTop:e.margin,borderRadius:e.borderRadiusSM,borderColor:e.colorBorderDashed,color:e.colorTextSecondary,"&:hover":{color:e.colorPrimaryText,borderColor:e.colorPrimary}},addItemButton:{marginTop:e.marginLG,borderRadius:e.borderRadiusSM,borderColor:e.colorPrimaryBorderDashed,color:e.colorPrimary,"&:hover":{background:e.colorPrimaryBgHover}},specificationRow:{marginBottom:e.marginXXS},summaryRow:{fontWeight:e.fontWeightStrong,borderTop:`1px dashed ${e.colorBorderSecondary}`,paddingTop:e.paddingMD,marginTop:e.marginLG},totalField:{width:"100%",borderRadius:e.borderRadiusSM,textAlign:"right",backgroundColor:e.colorFillTertiary,borderColor:e.colorBorder,color:e.colorText},grandTotalField:{width:"100%",borderRadius:e.borderRadiusSM,color:e.colorSuccess,fontSize:e.fontSizeHeading4,fontWeight:e.fontWeightStronger,textAlign:"right",backgroundColor:e.colorSuccessBg,borderColor:e.colorSuccessBorder},notesCard:{background:e.colorFillQuaternary,marginBottom:e.margin,borderRadius:e.borderRadiusLG,border:`1px solid ${e.colorBorderQuaternary}`},noteText:{margin:0,paddingBottom:e.paddingXXS,color:e.colorTextSecondary,fontSize:e.fontSizeSM,lineHeight:1.5},buttonGroup:{marginTop:e.marginLG,paddingTop:e.paddingMD,borderTop:`1px solid ${e.colorBorderSecondary}`,display:"flex",justifyContent:"flex-end",gap:e.marginSM}}),p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));function be(e,u=0){return(p[e[u+0]]+p[e[u+1]]+p[e[u+2]]+p[e[u+3]]+"-"+p[e[u+4]]+p[e[u+5]]+"-"+p[e[u+6]]+p[e[u+7]]+"-"+p[e[u+8]]+p[e[u+9]]+"-"+p[e[u+10]]+p[e[u+11]]+p[e[u+12]]+p[e[u+13]]+p[e[u+14]]+p[e[u+15]]).toLowerCase()}let Q;const Se=new Uint8Array(16);function je(){if(!Q){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Q=crypto.getRandomValues.bind(crypto)}return Q(Se)}const Ie=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),te={randomUUID:Ie};function S(e,u,h){var b;if(te.randomUUID&&!e)return te.randomUUID();e=e||{};const f=e.random??((b=e.rng)==null?void 0:b.call(e))??je();if(f.length<16)throw new Error("Random bytes length must be >= 16");return f[6]=f[6]&15|64,f[8]=f[8]&63|128,be(f)}const{Option:q}=M,{TextArea:oe}=x,{useToken:Te}=me,Le=({onCancel:e,onSave:u,initialValues:h,isSaving:f})=>{const[b]=n.useForm(),[w,se]=y.useState([]),[H,ie]=y.useState([]),[T,C]=y.useState([{id:S(),productId:null,productName:"",description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:S(),name:"",value:""}]}]),[R,ae]=y.useState([]),[O,z]=y.useState(null),[g,G]=y.useState(null),{token:L}=Te(),s=fe(L),A=y.useRef(!1),U=y.useRef(!1),N=y.useCallback(t=>{var o,i;return t?`
${(o=t.businessName)==null?void 0:o.toUpperCase()}
${t.contactName?`Mr. ${(i=t.contactName)==null?void 0:i.toUpperCase()}`:""}
${t.addressLine1||""}${t.addressLine2?", "+t.addressLine2:""}
${t.city||""}${t.pincode?" - "+t.pincode:""}
${t.state||""}, ${t.country||""}
${t.gstNumber||""}
${t.email||""} 
`.trim():""},[]),W=y.useCallback(async()=>{if(A.current)return;A.current=!0;const t=j.loading("Loading business options...");try{const o=await k.get("/api/quotations/leads/active");se(o.data),j.success("Business options loaded",{id:t})}catch(o){j.error("Failed to load businesses",{id:t}),console.error("Error fetching business options:",o),A.current=!1}},[]),_=y.useCallback(async()=>{if(U.current)return;U.current=!0;const t=j.loading("Loading product options...");try{const o=await k.get("/api/product");ie(o.data.map(i=>({...i,productName:i.productName||i.name||"",hsnSac:i.hsnSac||"",quantityType:i.quantityType||"",options:i.options||[]}))),j.success("Product options loaded",{id:t})}catch(o){j.error("Failed to load products",{id:t}),console.error("Error fetching product options:",o),U.current=!1}},[]);y.useEffect(()=>{if(W(),_(),h){b.setFieldsValue({...h,date:h.date?ee(h.date):null,validUntil:h.validUntil?ee(h.validUntil):null,noteText:""});const t=(h.items||[]).map(o=>({...o,id:o.id||S(),productName:o.productName||"",specifications:(o.specifications||[]).map(i=>({...i,key:i.key||S()}))}));if(C(t),ae(h.notes||[]),z(h.gstType||null),h.businessId&&w.length>0){const o=w.find(i=>i._id===h.businessId);o&&(G(o),b.setFieldsValue({businessName:o.businessName,businessType:o.type,gstin:o.gstNumber,businessInfo:N(o)}))}}},[h,W,_,b,N,w]);const le=async t=>{var m,l;if(!T||T.length===0){j.error("At least one item is required.");return}if(!O){j.error("Please select a GST type.");return}for(const c of T)if(c.specifications&&c.specifications.length>0){for(const P of c.specifications)if(!P.name.trim()||!P.value.trim()){j.error("All specification name and value fields must be filled for all items.");return}}const o=new Date().toLocaleString(),i=t.noteText?{text:t.noteText,timestamp:o}:null,a={...t,date:(m=t.date)==null?void 0:m.format("YYYY-MM-DD"),validUntil:(l=t.validUntil)==null?void 0:l.format("YYYY-MM-DD"),items:T,notes:i?[...R,i]:R,subTotal:D(),tax:E(),total:V(),createdDate:new Date().toLocaleDateString(),gstType:O,businessName:g==null?void 0:g.businessName,businessType:g==null?void 0:g.type,gstin:g==null?void 0:g.gstNumber,businessInfo:g?N(g):"",customerName:t.customerName,customerEmail:t.customerEmail};try{await u(a)}catch(c){console.error("Error in QuotationForm onFinish:",c)}},ne=()=>C(t=>[...t,{id:S(),productId:null,productName:"",description:"",hsnSac:"",quantity:1,rate:0,quantityType:"",specifications:[{key:S(),name:"",value:""}]}]),de=t=>C(T.filter(o=>o.id!==t)),B=(t,o,i)=>{C(a=>a.map(m=>{if(m.id===t){if(o==="productId"){const l=H.find(c=>c._id===i);if(l){let c=m.specifications||[];const P=c.length===0||c.length===1&&c[0].name===""&&c[0].value==="";return l.options&&l.options.length>0&&P?c=l.options.map(J=>({key:S(),name:J.type||"",value:J.description||""})):(!l.options||l.options.length===0)&&c.length===0&&(c=[{key:S(),name:"",value:""}]),{...m,productId:i,productName:l.productName||l.name||"",description:l.description||"",hsnSac:l.hsnSac||"",rate:l.price||0,quantityType:l.quantityType||"",specifications:c}}else return{...m,productId:null,productName:"",description:"",hsnSac:"",rate:0,quantityType:"",specifications:[{key:S(),name:"",value:""}]}}return{...m,[o]:i}}return m}))},X=t=>{C(o=>o.map(i=>i.id===t?{...i,specifications:[...i.specifications,{key:S(),name:"",value:""}]}:i))},ce=(t,o)=>{C(i=>i.map(a=>a.id===t?{...a,specifications:a.specifications.filter(m=>m.key!==o)}:a))},K=(t,o,i,a)=>{C(m=>m.map(l=>l.id===t?{...l,specifications:l.specifications.map(c=>c.key===o?{...c,[i]:a}:c)}:l))},D=()=>T.reduce((t,o)=>t+(o.quantity||0)*(o.rate||0),0),E=()=>D()*.18,V=()=>D()+E(),ue=t=>{const o=w.find(i=>i._id===t);if(o){G(o);const i=N(o);b.setFieldsValue({businessId:o._id,businessName:o.businessName,businessType:o.type,gstin:o.gstNumber,businessInfo:i})}else G(null),b.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:""})};return r.jsx($,{title:r.jsx("span",{style:s.mainCardTitle,children:h?"Edit Quotation":"Create New Quotation"}),loading:f,style:s.quotationCard,children:r.jsxs(n,{form:b,layout:"vertical",onFinish:le,children:[r.jsx(v,{style:s.divider,children:"Customer Details"}),r.jsxs(I,{gutter:[16,24],children:[r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0,message:"Please enter customer name!"},{min:2,message:"Customer name must be at least 2 characters!"}],children:r.jsx(x,{placeholder:"Enter customer full name",style:s.formField})})}),r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{label:"Customer Email",name:"customerEmail",rules:[{required:!0,message:"Please enter customer email!"},{type:"email",message:"Please enter a valid email address!"}],children:r.jsx(x,{placeholder:"Enter customer email address",style:s.formField,type:"email"})})})]}),r.jsx(v,{style:s.divider,children:"Business Details"}),r.jsxs(I,{gutter:[16,24],children:[r.jsxs(d,{xs:24,md:12,children:[r.jsx(n.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:r.jsx(M,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(t,o)=>((o==null?void 0:o.children)||"").toLowerCase().includes(t.toLowerCase()),onChange:ue,allowClear:!0,style:s.formField,children:w.map(t=>r.jsx(q,{value:t._id,children:t.businessName},t._id))})}),r.jsx(n.Item,{name:"businessName",hidden:!0,children:r.jsx(x,{})})]}),r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{name:"businessType",label:"Type",children:r.jsx(x,{readOnly:!0,style:s.readOnlyFormField})})})]}),r.jsxs(I,{gutter:[16],children:[r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:r.jsxs(M,{placeholder:"Select GST calculation type",onChange:t=>z(t),value:O,style:s.formField,children:[r.jsx(q,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),r.jsx(q,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{label:"Business Info",children:r.jsx($,{bordered:!0,style:s.businessInfoCard,children:r.jsx("pre",{style:s.businessInfoPre,children:b.getFieldValue("businessInfo")||"Select a business to view details..."})})})})]}),r.jsx(v,{style:s.divider,children:"Quotation Details"}),r.jsxs(I,{gutter:[16,24],children:[r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select a date!"}],children:r.jsx(re,{style:s.formField,format:"DD/MM/YYYY"})})}),r.jsx(d,{xs:24,md:12,children:r.jsx(n.Item,{name:"validUntil",label:"Valid Until",children:r.jsx(re,{style:s.formField,format:"DD/MM/YYYY"})})})]}),r.jsx(v,{style:s.divider,children:"Quotation Items"}),T.map((t,o)=>{const i=t.productId!==null;return r.jsxs($,{style:s.itemCard,size:"small",children:[r.jsxs(I,{gutter:[16,16],align:"middle",children:[r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"Product",noStyle:!0,children:r.jsx(M,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(a,m)=>((m==null?void 0:m.children)||"").toLowerCase().includes(a.toLowerCase()),onChange:a=>B(t.id,"productId",a),value:t.productId,style:s.formField,children:H.map(a=>r.jsx(q,{value:a._id,children:a.productName||a.name},a._id))})})}),r.jsx(d,{xs:12,sm:4,children:r.jsx(n.Item,{label:"Qty",noStyle:!0,children:r.jsx(pe,{placeholder:"1",value:t.quantity,onChange:a=>B(t.id,"quantity",a),style:s.formField,min:0})})}),r.jsx(d,{xs:12,sm:6,children:r.jsx(n.Item,{label:"Unit Type",noStyle:!0,children:r.jsx(x,{placeholder:"e.g., Pcs, Kg, Mtr",value:t.quantityType,onChange:a=>B(t.id,"quantityType",a.target.value),style:i?s.readOnlyFormField:s.formField,readOnly:i,disabled:i})})}),r.jsx(d,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:T.length>1&&r.jsx(Y,{title:"Remove Item",children:r.jsx(F,{icon:r.jsx(he,{}),danger:!0,onClick:()=>de(t.id),type:"text",style:s.deleteButton})})})]}),r.jsxs(I,{gutter:[16,16],style:{marginTop:L.marginS},children:[r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"Price (per unit)",noStyle:!0,children:r.jsx(x,{prefix:"₹",value:t.rate.toFixed(2),readOnly:!0,style:s.readOnlyFormField})})}),r.jsx(d,{xs:24,sm:16,children:r.jsx(n.Item,{label:"Description",noStyle:!0,children:r.jsx(oe,{placeholder:"Detailed description of the item",value:t.description,onChange:a=>B(t.id,"description",a.target.value),style:i?s.readOnlyTextArea:s.textAreaField,rows:2})})})]}),r.jsxs(I,{gutter:[16,16],style:{marginTop:L.marginS},children:[r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"HSN/SAC Code",noStyle:!0,children:r.jsx(x,{placeholder:"HSN/SAC",value:t.hsnSac,onChange:a=>B(t.id,"hsnSac",a.target.value),style:i?s.readOnlyFormField:s.formField,readOnly:i,disabled:i})})}),r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"Item Total",noStyle:!0,children:r.jsx(x,{value:`₹${((t.quantity||0)*(t.rate||0)).toFixed(2)}`,readOnly:!0,style:s.totalItemField})})})]}),t.specifications&&t.specifications.length>0&&r.jsxs(r.Fragment,{children:[r.jsx(v,{orientation:"left",style:s.specificationDivider,children:"Specifications"}),t.specifications.map((a,m)=>r.jsxs(I,{gutter:16,style:s.specificationRow,align:"middle",children:[r.jsx(d,{xs:24,sm:10,children:r.jsx(x,{placeholder:"Specification Name (e.g., Color)",value:a.name,onChange:l=>K(t.id,a.key,"name",l.target.value),style:s.formField})}),r.jsx(d,{xs:24,sm:10,children:r.jsx(x,{placeholder:"Specification Value (e.g., Blue)",value:a.value,onChange:l=>K(t.id,a.key,"value",l.target.value),style:s.formField})}),r.jsx(d,{xs:24,sm:4,children:r.jsxs(Z,{children:[t.specifications.length>1&&r.jsx(Y,{title:"Remove Specification",children:r.jsx(F,{icon:r.jsx(xe,{}),onClick:()=>ce(t.id,a.key),type:"text",danger:!0,style:s.deleteButton})}),m===t.specifications.length-1&&r.jsx(Y,{title:"Add New Specification",children:r.jsx(F,{icon:r.jsx(ye,{}),onClick:()=>X(t.id),type:"dashed",style:s.addButton})})]})})]},a.key))]}),(!t.specifications||t.specifications.length===0||t.specifications.length>0&&t.specifications[t.specifications.length-1].name&&t.specifications[t.specifications.length-1].value)&&r.jsx(F,{onClick:()=>X(t.id),block:!0,type:"dashed",style:s.addSpecButton,children:"+ Add Specification"})]},t.id)}),r.jsx(F,{onClick:ne,block:!0,type:"dashed",style:s.addItemButton,children:"+ Add Another Item"}),r.jsx(v,{style:s.divider,children:"Quotation Summary"}),r.jsxs(I,{gutter:[16,16],style:s.summaryRow,children:[r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"Sub Total",children:r.jsx(x,{readOnly:!0,value:`₹${D().toFixed(2)}`,style:s.totalField})})}),r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"GST (18%)",children:r.jsx(x,{readOnly:!0,value:`₹${E().toFixed(2)}`,style:s.totalField})})}),r.jsx(d,{xs:24,sm:8,children:r.jsx(n.Item,{label:"Total Amount",children:r.jsx(x,{readOnly:!0,value:`₹${V().toFixed(2)}`,style:s.grandTotalField})})})]}),R.length>0&&r.jsx(n.Item,{label:"Existing Notes",children:r.jsx($,{style:s.notesCard,children:R.map((t,o)=>r.jsxs("p",{style:s.noteText,children:[r.jsxs("strong",{children:[t.timestamp,":"]})," ",t.text]},o))})}),r.jsx(n.Item,{name:"noteText",label:"Add New Note",children:r.jsx(oe,{rows:3,style:s.textAreaField,placeholder:"Add any additional notes, terms, or conditions for this quotation..."})}),r.jsx(n.Item,{style:s.buttonGroup,children:r.jsxs(Z,{size:"middle",children:[r.jsx(F,{onClick:e,disabled:f,size:"large",children:"Cancel"}),r.jsx(F,{htmlType:"submit",type:"primary",icon:r.jsx(ge,{}),loading:f,size:"large",children:"Save Quotation"})]})})]})})};export{Le as default};
